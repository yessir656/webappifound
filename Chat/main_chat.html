<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="main_chat.css">
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"></script>
    <title>IFound Chat</title>
</head>
<body>
    <!-- Recent Chat Display-->
    <div class="recent_chat">
        <div class="recent-chat-title">
            <img src="img/4.png" alt="Description of image" class="logo" onclick="redirectToUserChat()">
            <h1 class="recent-title">Chats</h1>
        </div>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search chats..." class="search-input">
            <button id="searchButton" class="search-button">
                <i class="search-icon">üîç</i>
            </button>
        </div>
        <div class="chat-list-container"></div>
        
    </div>

    <!-- Main Chat Display -->
    <div class="main_chat">
        <div class="user_profile">
            <img src="img/user_icon.png" class="user_icon">
            <h1 class="chatmate"></h1>
        </div>
        <div class="message-content"></div>
        <div class="send_message">
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
            <img src="img/image.png" class="image_icon" alt="Send" onclick="document.getElementById('imageInput').click();">
            <input type="text" class="message_input" placeholder="Type a message...">
            <img src="img/send__icon.png" class="send_icon" alt="Send">
        </div>
    </div>

    <!-- Additional Info Display -->
    <div class="profile">
        <!-- This will be the clickable icon that opens file selection -->
        
    </div>


    <script type="module" src="recent_chat.js"></script>
    <script type="module" src="send_chat.js"></script>
    <script type="module">
        import { filterChats } from './recent_chat.js';

        document.getElementById('searchButton').addEventListener('click', () => {
            const searchQuery = document.getElementById('searchInput').value.trim().toLowerCase();
            filterChats(searchQuery);
        });

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchQuery = e.target.value.trim().toLowerCase();
            filterChats(searchQuery);
        });

        function redirectToUserChat() {
            const currentUser = auth.currentUser;
            if (currentUser) {
                const userChatRoomId = currentRoomId; // Use the current chat room ID
                if (userChatRoomId) {
                    getChatMessages(currentUser.uid, userChatRoomId);
                } else {
                    alert("No active chat room found.");
                }
            } else {
                alert("You must be logged in to access your chat.");
            }
        }
    </script>
    <script type="module">
        import { listenToChatMessages, sendMessage } from './send_chat.js';
        import { getChatRoomId } from './recent_chat.js';

        // Example: Start listening to messages when a chat room is opened
        const chatRoomId = getChatRoomId(); // Replace with the actual chat room ID
        const otherUserId = "OTHER_USER_ID"; // Replace with the actual other user's ID
        listenToChatMessages(chatRoomId, otherUserId);

        document.querySelector(".send_icon").addEventListener("click", async () => {
            const messageInput = document.querySelector(".message_input");
            const imageInput = document.getElementById("imageInput");
            const message = messageInput.value.trim();
            const imageFile = imageInput.files[0];

            if (!message && !imageFile) {
                alert("Please enter a message or select an image to send.");
                return;
            }

            try {
                await sendMessage(chatRoomId, message, imageFile);
                messageInput.value = "";
                imageInput.value = ""; // Clear the file input
            } catch (error) {
                alert("Error sending message: " + error.message);
            }
        });
    </script>

</body>
</html>

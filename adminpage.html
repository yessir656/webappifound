<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page</title>
    <link rel="stylesheet" href="adminstyles.css">
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
</head>
<body>
    <div class="container">
        <h2>Admin Dashboard</h2>
        <table id="userTable">
            <thead>
                <tr>
                    <th>Student ID</th>
                     <th>Email</th>
                    <th>Username</th>
                    <th>Password</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Users will be dynamically added here -->
            </tbody>
        </table>
        
        <h3>Add New Student ID and Email</h3>
        <input type="text" id="newStudentId" placeholder="Student ID">
        <input type="email" id="newStudentEmail" placeholder="Student Email">
        <button id="addStudentIdButton">Add Student ID</button>
        <br><br>

        <h3>Deleted Posts</h3>
        <table id="deletedPostsTable">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Deleted At</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Deleted posts will be dynamically added here -->
            </tbody>
        </table>

        <h3>Posts</h3>
        <table id="postsTable">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Posted By</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Posts will be dynamically added here -->
            </tbody>
        </table>
        <br><br>
        <button onclick="window.location.href='mainpage.html'">Go to Main Page</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDJHgD-oUB2h5rVvB0ISDR_pyqMpt9Gdn0",
            authDomain: "webapplostandfound.firebaseapp.com",
            projectId: "webapplostandfound",
            storageBucket: "webapplostandfound.firebasestorage.app",
            messagingSenderId: "23544433053",
            appId: "1:23544433053:web:ad48cddc2b2f39407c4774",
            measurementId: "G-2LGQZ7VY6P"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Set isAdmin flag in localStorage when admin accesses the page
        localStorage.setItem("isAdmin", "true");

        document.getElementById("addStudentIdButton").addEventListener("click", async () => {
            const studentId = document.getElementById("newStudentId").value.trim();
            const studentEmail = document.getElementById("newStudentEmail").value.trim();

            if (!studentId || !studentEmail) {
                alert("Please enter both Student ID and Email.");
                return;
            }

            try {
                const studentIdQuery = await getDocs(collection(db, "users"));
                const studentExists = studentIdQuery.docs.some(doc => 
                    doc.data().studentId === studentId && doc.data().email === studentEmail
                );

                if (studentExists) {
                    alert("The combination of Student ID and Email already exists. Please use a different one.");
                    return;
                }

                const newDocRef = doc(collection(db, "users"));
                await setDoc(newDocRef, { studentId, email: studentEmail, password: null, uid: newDocRef.id });

                alert("Student ID and Email successfully added!");
                loadUsers();
            } catch (error) {
                alert("Error adding Student ID: " + error.message);
            }
        });

        async function loadUsers() {
            const querySnapshot = await getDocs(collection(db, "users"));
            const userTable = document.getElementById("userTable").querySelector("tbody");
            userTable.innerHTML = "";
            querySnapshot.forEach((doc) => {
                const user = doc.data();
                // Correctly determine availability based on username and password
                const isAvailable = !user.username && !user.password;
                const status = isAvailable ? "Available" : "Unavailable";
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td><input type="text" value="${user.studentId}" data-id="${doc.id}" class="editStudentId"></td>
                    <td><input type="email" value="${user.email || ''}" data-id="${doc.id}" class="editEmail"></td>
                    <td><input type="text" value="${user.username || ''}" data-id="${doc.id}" class="editUsername"></td>
                    <td><input type="text" value="${user.password || ''}" data-id="${doc.id}" class="editPassword"></td>
                    <td>${status}</td>
                    <td>
                        <button class="saveUser" data-id="${doc.id}">Save</button>
                        <button class="deleteUser" data-id="${doc.id}">Delete</button>
                    </td>
                `;
                userTable.appendChild(row);
            });
        }

        document.addEventListener("click", async (event) => {
            if (event.target.classList.contains("saveUser")) {
                const userId = event.target.getAttribute("data-id");
                const newStudentId = document.querySelector(`input.editStudentId[data-id='${userId}']`).value.trim();
                const newUsername = document.querySelector(`input.editUsername[data-id='${userId}']`).value.trim();
                const newEmail = document.querySelector(`input.editEmail[data-id='${userId}']`).value.trim();
                const newPassword = document.querySelector(`input.editPassword[data-id='${userId}']`).value.trim();

                if (!newStudentId) {
                    alert("Student ID cannot be empty.");
                    return;
                }

                // Check if newStudentId already exists
                const studentIdQuery = await getDocs(collection(db, "users"));
                const studentIdExists = studentIdQuery.docs.some(doc => doc.id !== userId && doc.data().studentId === newStudentId);

                if (studentIdExists) {
                    alert("Student ID already exists. Please use a different one.");
                    return;
                }

                await updateDoc(doc(db, "users", userId), {
                    studentId: newStudentId,
                    username: newUsername || null,
                    email: newEmail || null,
                    password: newPassword || null
                });

                alert("User updated successfully");
                loadUsers();
            }

            if (event.target.classList.contains("deleteUser")) {
                const userId = event.target.getAttribute("data-id");
                await deleteDoc(doc(db, "users", userId));
                alert("Student ID deleted successfully");
                loadUsers();
            }
        });

        loadUsers();

        // Function to load deleted posts from Firestore
        async function loadDeletedPosts() {
            const querySnapshot = await getDocs(collection(db, "deletedPosts"));
            const deletedPostsTable = document.getElementById("deletedPostsTable").querySelector("tbody");
            deletedPostsTable.innerHTML = ""; // Clear existing rows

            querySnapshot.forEach((doc) => {
                const deletedPost = doc.data();
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${deletedPost.description}</td>
                    <td>${deletedPost.category}</td>
                    <td>${new Date(deletedPost.deletedAt).toLocaleString()}</td>
                    <td>
                        <button class="recoverPost" data-id="${doc.id}">Recover</button>
                    </td>
                `;
                deletedPostsTable.appendChild(row);
            });
        }

        // Periodically check for deleted posts
        setInterval(loadDeletedPosts, 1000);

        // Function to load posts from Firestore
        async function loadPosts() {
            const querySnapshot = await getDocs(collection(db, "posts"));
            const postsTable = document.getElementById("postsTable").querySelector("tbody");
            postsTable.innerHTML = ""; // Clear existing rows

            querySnapshot.forEach((doc) => {
                const post = doc.data();
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>
                        ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post Image" style="max-width: 100px; height: auto; border-radius: 8px;">` : "No Image"}
                    </td>
                    <td>${post.description}</td>
                    <td>${post.category}</td>
                    <td>${post.userId || "Unknown"}</td>
                    <td>
                        <button class="deletePost" data-id="${doc.id}">Delete</button>
                    </td>
                `;
                postsTable.appendChild(row);
            });
        }

        // Event listener for deleting posts
        document.addEventListener("click", async (event) => {
            if (event.target.classList.contains("deletePost")) {
                const postId = event.target.getAttribute("data-id");
                try {
                    // Get the post data before deleting
                    const postDoc = await getDoc(doc(db, "posts", postId));
                    if (postDoc.exists()) {
                        const postData = postDoc.data();

                        // Add the post to the "deletedPosts" collection
                        await setDoc(doc(db, "deletedPosts", postId), {
                            ...postData,
                            deletedAt: new Date().toISOString()
                        });

                        // Delete the post from the "posts" collection
                        await deleteDoc(doc(db, "posts", postId));

                        alert("Post deleted successfully");
                        loadPosts(); // Refresh the posts table
                        loadDeletedPosts(); // Refresh the deleted posts table
                    } else {
                        alert("Post not found.");
                    }
                } catch (error) {
                    alert("Error deleting post: " + error.message);
                }
            }
        });

        // Event listener for recovering posts
        document.addEventListener("click", async (event) => {
            if (event.target.classList.contains("recoverPost")) {
                const postId = event.target.getAttribute("data-id");
                try {
                    // Get the deleted post from Firestore
                    const deletedPostDoc = await getDoc(doc(db, "deletedPosts", postId));
                    if (deletedPostDoc.exists()) {
                        const deletedPostData = deletedPostDoc.data();

                        // Add the post back to the "posts" collection
                        await setDoc(doc(db, "posts", postId), deletedPostData);

                        // Remove the post from the "deletedPosts" collection
                        await deleteDoc(doc(db, "deletedPosts", postId));

                        alert("Post recovered successfully");
                        loadDeletedPosts(); // Refresh the deleted posts table
                        loadPosts(); // Refresh the posts table
                    } else {
                        alert("Post not found in deleted posts.");
                    }
                } catch (error) {
                    alert("Error recovering post: " + error.message);
                }
            }
        });
                    // Prevent caching and force reload on back navigation
            window.onpageshow = function(event) {
                if (event.persisted || performance.getEntriesByType("navigation")[0].type === "back_forward") {
                    // Reload page on back/forward navigation
                    window.location.reload();
                }
            };


        // Load posts on page load
        loadPosts();
    </script>
</body>
</html>
